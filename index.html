<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>
  <body>
    <script>
      // --- 1. OneEuroFilter Class Implementation (Do not change this) ---
      class LowPassFilter {
        constructor(alpha) {
          this.setAlpha(alpha);
          this.y = null;
        }
        setAlpha(alpha) {
          if (alpha <= 0 || alpha > 1) {
            throw new Error('alpha should be in (0, 1]');
          }
          this.alpha = alpha;
        }
        filter(value, timestamp) {
          if (this.y === null) {
            this.y = value;
          } else {
            this.y = this.alpha * value + (1.0 - this.alpha) * this.y;
          }
          return this.y;
        }
      }

      class OneEuroFilter {
        constructor(freq, minCutoff, beta, dCutoff) {
          if (freq <= 0) {
            throw new Error('freq should be > 0');
          }
          this.freq = freq;
          this.minCutoff = minCutoff;
          this.beta = beta;
          this.dCutoff = dCutoff || 1.0;
          this.x = new LowPassFilter(this.alpha(minCutoff));
          this.dx = new LowPassFilter(this.alpha(dCutoff));
          this.lastTime = null;
        }

        alpha(cutoff) {
          let te = 1.0 / this.freq;
          let tau = 1.0 / (2 * Math.PI * cutoff);
          return 1.0 / (1.0 + tau / te);
        }

        filter(value, timestamp) {
          if (this.lastTime != null) {
            this.freq = 1.0 / (timestamp - this.lastTime);
          }
          this.lastTime = timestamp;

          let prevX = this.x.y === null ? value : this.x.y;
          let dvalue = this.x.y === null ? 0 : (value - prevX) * this.freq;
          let edx = this.dx.filter(dvalue, timestamp);

          let cutoff = this.minCutoff + this.beta * Math.abs(edx);
          
          // Update the LPF alpha before filtering the main value
          this.x.setAlpha(this.alpha(cutoff));
          
          return this.x.filter(value, timestamp);
        }
      }

      // --- 2. Custom A-Frame Component (Uses the Filter) ---
      AFRAME.registerComponent('smooth-tracking', {
          schema: {
              // STARTING WITH AGGRESSIVE SMOOTHING. Tune these!
              minCutoff: { type: 'number', default: 0.1 }, 
              beta: { type: 'number', default: 0.005 },   
          },

          init: function() {
              const { minCutoff, beta } = this.data;
              const freq = 60; // Assumed FPS

              // Initialize filters for Position (X, Y, Z)
              this.filterP_X = new OneEuroFilter(freq, minCutoff, beta);
              this.filterP_Y = new OneEuroFilter(freq, minCutoff, beta);
              this.filterP_Z = new OneEuroFilter(freq, minCutoff, beta);

              // Initialize filters for Rotation (Euler X, Y, Z)
              this.filterR_X = new OneEuroFilter(freq, minCutoff, beta);
              this.filterR_Y = new OneEuroFilter(freq, minCutoff, beta);
              this.filterR_Z = new OneEuroFilter(freq, minCutoff, beta);
              
              // Reference to the entity's low-level transformation
              this.rawObject3D = this.el.object3D; 
              this.isTracking = false;

              // Event listeners
              this.el.addEventListener('targetFound', () => {
                  this.isTracking = true;
              });
              this.el.addEventListener('targetLost', () => {
                  this.isTracking = false;
              });
          },

          tick: function(time, deltaTime) {
              if (!this.isTracking) return;

              const timestamp = time / 1000.0; // Time in seconds
              
              // --- 1. Read RAW values from the object3D (set by MindAR) ---
              const rawP = this.rawObject3D.position;
              // Convert Quaternion to Euler angles for filtering individual axes
              const rawR = new THREE.Euler().setFromQuaternion(this.rawObject3D.quaternion, 'YXZ'); 

              // --- 2. Filter Position ---
              const fX = this.filterP_X.filter(rawP.x, timestamp);
              const fY = this.filterP_Y.filter(rawP.y, timestamp);
              const fZ = this.filterP_Z.filter(rawP.z, timestamp);
              
              // --- 3. Filter Rotation (convert to Degrees, filter, then convert back) ---
              // Filter the rotation in degrees (easier to tune)
              const rX = this.filterR_X.filter(THREE.MathUtils.radToDeg(rawR.x), timestamp);
              const rY = this.filterR_Y.filter(THREE.MathUtils.radToDeg(rawR.y), timestamp);
              const rZ = this.filterR_Z.filter(THREE.MathUtils.radToDeg(rawR.z), timestamp);

              // --- 4. Apply SMOOTHED Pose directly to the object3D ---
              this.rawObject3D.position.set(fX, fY, fZ);
              
              // Convert filtered degrees back to radians and set the rotation
              this.rawObject3D.rotation.set(
                  THREE.MathUtils.degToRad(rX),
                  THREE.MathUtils.degToRad(rY),
                  THREE.MathUtils.degToRad(rZ),
                  'YXZ'
              );
          }
      });
    </script>
    <a-scene 
      mindar-image="imageTargetSrc: https://dhkyzhpqoreeytuyeioj.supabase.co/storage/v1/object/public/Foodmenue/targets.mind;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="avatarModel" src="simple_pizza.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity 
        mindar-image-target="targetIndex: 0" 
        smooth-tracking="minCutoff: 0.1; beta: 0.005">
        
        <a-gltf-model rotation="90 0 0" position="0 0 0.1" scale="0.4 0.4 0.4" src="#avatarModel"></a-gltf-model>
      </a-entity>
    </a-scene>
  </body>
</html>
