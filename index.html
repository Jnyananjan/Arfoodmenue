<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>
  <body>
    <script>
      // NOTE: This is a direct implementation of the OneEuroFilter class in JavaScript
      // We need it to filter the raw X, Y, Z position and rotation values.

      class LowPassFilter {
        constructor(alpha) {
          this.setAlpha(alpha);
          this.y = null;
        }
        setAlpha(alpha) {
          if (alpha <= 0 || alpha > 1) {
            throw new Error('alpha should be in (0, 1]');
          }
          this.alpha = alpha;
        }
        filter(value, timestamp) {
          if (this.y === null) {
            this.y = value;
          } else {
            this.y = this.alpha * value + (1.0 - this.alpha) * this.y;
          }
          return this.y;
        }
      }

      class OneEuroFilter {
        constructor(freq, minCutoff, beta, dCutoff) {
          if (freq <= 0) {
            throw new Error('freq should be > 0');
          }
          this.freq = freq;
          this.minCutoff = minCutoff;
          this.beta = beta;
          this.dCutoff = dCutoff || 1.0;
          this.x = new LowPassFilter(this.alpha(minCutoff));
          this.dx = new LowPassFilter(this.alpha(dCutoff));
          this.lastTime = null;
        }

        alpha(cutoff) {
          let te = 1.0 / this.freq;
          let tau = 1.0 / (2 * Math.PI * cutoff);
          return 1.0 / (1.0 + tau / te);
        }

        filter(value, timestamp) {
          if (this.lastTime != null) {
            this.freq = 1.0 / (timestamp - this.lastTime);
          }
          this.lastTime = timestamp;

          let prevX = this.x.y === null ? value : this.x.y;
          let dvalue = this.x.y === null ? 0 : (value - prevX) * this.freq;
          let edx = this.dx.filter(dvalue, timestamp);

          let cutoff = this.minCutoff + this.beta * Math.abs(edx);
          
          // Update the LPF alpha before filtering the main value
          this.x.setAlpha(this.alpha(cutoff));
          
          return this.x.filter(value, timestamp);
        }
      }

      // --- CUSTOM A-FRAME COMPONENT ---
      AFRAME.registerComponent('smooth-tracking', {
        schema: {
          // Tunable parameters for the OneEuroFilter
          minCutoff: { type: 'number', default: 0.5 }, // Controls jitter at low speed
          beta: { type: 'number', default: 0.005 },   // Controls lag at high speed
        },

        init: function() {
          const { minCutoff, beta } = this.data;
          const freq = 60; // Assuming 60 FPS, adjust if needed

          // 1. Initialize filters for Position (X, Y, Z)
          this.filterP_X = new OneEuroFilter(freq, minCutoff, beta);
          this.filterP_Y = new OneEuroFilter(freq, minCutoff, beta);
          this.filterP_Z = new OneEuroFilter(freq, minCutoff, beta);

          // 2. Initialize filters for Rotation (Euler X, Y, Z)
          this.filterR_X = new OneEuroFilter(freq, minCutoff, beta);
          this.filterR_Y = new OneEuroFilter(freq, minCutoff, beta);
          this.filterR_Z = new OneEuroFilter(freq, minCutoff, beta);
          
          // Store the raw pose component (from MindAR)
          this.rawPoseComponent = this.el.components['mindar-image-target'];

          // Flag to check if tracking is active
          this.isTracking = false;

          // Event listeners for MindAR
          this.el.addEventListener('targetFound', () => {
            this.isTracking = true;
          });
          this.el.addEventListener('targetLost', () => {
            this.isTracking = false;
          });
        },

        tick: function(time, deltaTime) {
          if (!this.isTracking) return;

          // Time in seconds for the filter
          const timestamp = time / 1000.0; 

          // --- 1. Get RAW Position and Rotation ---
          const rawPosition = this.el.getAttribute('position');
          const rawRotation = this.el.getAttribute('rotation');

          // --- 2. Filter Position ---
          const fX = this.filterP_X.filter(rawPosition.x, timestamp);
          const fY = this.filterP_Y.filter(rawPosition.y, timestamp);
          const fZ = this.filterP_Z.filter(rawPosition.z, timestamp);
          
          // --- 3. Filter Rotation (Euler Angles) ---
          const rX = this.filterR_X.filter(rawRotation.x, timestamp);
          const rY = this.filterR_Y.filter(rawRotation.y, timestamp);
          const rZ = this.filterR_Z.filter(rawRotation.z, timestamp);

          // --- 4. Apply SMOOTHED Pose to the Entity ---
          // This is the crucial step: we override the raw pose applied by MindAR.
          this.el.setAttribute('position', { x: fX, y: fY, z: fZ });
          this.el.setAttribute('rotation', { x: rX, y: rY, z: rZ });
        }
      });
      // ------------------------------------------------------------------
      // ONEEUROFILTER IMPLEMENTATION & CUSTOM A-FRAME COMPONENT (END)
      // ------------------------------------------------------------------
    </script>

    <a-scene mindar-image="imageTargetSrc: https://dhkyzhpqoreeytuyeioj.supabase.co/storage/v1/object/public/Foodmenue/targets.mind;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      <a-assets>
        <a-asset-item id="avatarModel" src="simple_pizza.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" **smooth-tracking**>
        <a-gltf-model rotation="90 0 0" position="0 0 0.1" scale="0.4 0.4 0.4" src="#avatarModel"></a-gltf-model>
      </a-entity>
    </a-scene>
  </body>
</html>
